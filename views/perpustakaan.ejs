<div class="container mt-5">
  <h1>Daftar Buku Perpustakaan</h1>
  <p>Kelola daftar buku yang tersedia di perpustakaan.</p>

  <hr />

  <h3 class="mt-4">Tambah Buku Baru</h3>
  <form id="addBookForm" class="mb-4">
    <div class="form-row">
      <div class="col-md-5 mb-2">
        <input type="text" id="newJudul" class="form-control" placeholder="Judul Buku" required />
      </div>
      <div class="col-md-4 mb-2">
        <input type="text" id="newPenulis" class="form-control" placeholder="Nama Penulis" required />
      </div>
      <div class="col-md-2 mb-2">
        <input type="number" id="newTahun" class="form-control" placeholder="Tahun Terbit" required />
      </div>
      <div class="col-md-1 mb-2">
        <button class="btn btn-success btn-block" type="submit">Tambah</button>
      </div>
    </div>
  </form>

  <hr />

  <h3 class="mb-3">Daftar Buku</h3>
  <ul class="list-group" id="bookList">
    <% if (books && books.length > 0) { %>
      <% books.forEach(function(book) { %>
      <li class="list-group-item" data-id="<%= book.id %>">
        <div class="d-flex justify-content-between align-items-center" id="view-<%= book.id %>">
          <div>
            <strong><%= book.judul %></strong><br>
            <small class="text-muted">Penulis: <%= book.penulis %> | Tahun: <%= book.tahun_terbit %></small>
          </div>
          <div class="task-actions">
            <button class="btn btn-warning btn-sm mr-2" onclick="toggleEdit('<%= book.id %>')">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteBook('<%= book.id %>')">Delete</button>
          </div>
        </div>

        <div id="edit-<%= book.id %>" style="display: none;">
          <form onsubmit="updateBook(event, '<%= book.id %>')">
            <div class="form-row align-items-center">
              <div class="col-md-4"><input type="text" class="form-control" id="edit-judul-<%= book.id %>" value="<%= book.judul %>"></div>
              <div class="col-md-3"><input type="text" class="form-control" id="edit-penulis-<%= book.id %>" value="<%= book.penulis %>"></div>
              <div class="col-md-2"><input type="number" class="form-control" id="edit-tahun-<%= book.id %>" value="<%= book.tahun_terbit %>"></div>
              <div class="col-auto">
                <button class="btn btn-primary btn-sm" type="submit">Simpan</button>
                <button class="btn btn-secondary btn-sm" type="button" onclick="toggleEdit('<%= book.id %>')">Batal</button>
              </div>
            </div>
          </form>
        </div>
      </li>
      <% }); %>
    <% } else { %>
      <p>Belum ada buku yang ditambahkan.</p>
    <% } %>
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  function toggleEdit(id) {
    const viewDiv = document.getElementById(`view-${id}`);
    const editDiv = document.getElementById(`edit-${id}`);
    viewDiv.style.display = viewDiv.style.display === 'none' ? 'flex' : 'none';
    editDiv.style.display = editDiv.style.display === 'none' ? 'block' : 'none';
  }

  document.getElementById('addBookForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const judul = document.getElementById('newJudul').value;
    const penulis = document.getElementById('newPenulis').value;
    const tahun_terbit = document.getElementById('newTahun').value;

    try {
      await axios.post('/buku', { judul, penulis, tahun_terbit });
      alert('Buku berhasil ditambahkan!');
      window.location.reload();
    } catch (error) {
      console.error('Error adding book:', error);
      alert('Gagal menambahkan buku');
    }
  });

  async function updateBook(e, id) {
    e.preventDefault();
    const judul = document.getElementById(`edit-judul-${id}`).value;
    const penulis = document.getElementById(`edit-penulis-${id}`).value;
    const tahun_terbit = document.getElementById(`edit-tahun-${id}`).value;

    try {
      await axios.put(`/buku/${id}`, { judul, penulis, tahun_terbit });
      alert('Buku berhasil diperbarui!');
      window.location.reload();
    } catch (error) {
      console.error('Error updating book:', error);
      alert('Gagal memperbarui buku');
    }
  }

  async function deleteBook(id) {
    if (confirm('Apakah Anda yakin ingin menghapus buku ini?')) {
      try {
        await axios.delete(`/buku/${id}`);
        alert('Buku berhasil dihapus!');
        window.location.reload();
      } catch (error) {
        console.error('Error deleting book:', error);
        alert('Gagal menghapus buku');
      }
    }
  }
</script>